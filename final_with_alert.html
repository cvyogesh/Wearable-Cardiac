<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Classifier Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        @supports (font-variation-settings: normal) {
            body { font-family: 'Inter var', sans-serif; }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="text-white">

    <div class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Left Column: Input Dashboard -->
        <div class="glass-card p-8 space-y-6">
            <h2 class="text-3xl font-bold text-center border-b border-white/20 pb-4">Sensor Input Dashboard</h2>
            
            <!-- PPG HR -->
            <div class="space-y-2">
                <label for="ppgHR" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                    PPG Heart Rate (BPM)
                </label>
                <input id="ppgHR" type="number" value="75" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- ECG HR -->
            <div class="space-y-2">
                <label for="ecgHR" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2zm12-3c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2zM9 10l12-3"></path></svg>
                    ECG Heart Rate (BPM)
                </label>
                <input id="ecgHR" type="number" value="75" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- SpO2 -->
            <div class="space-y-2">
                <label for="spo2" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                    Blood Oxygen (SpO2 %)
                </label>
                <input id="spo2" type="number" value="98" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- HRV -->
            <div class="space-y-2">
                <label for="hrv" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    HRV (SDNN in ms)
                </label>
                <input id="hrv" type="number" value="40" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- Resp Rate -->
            <div class="space-y-2">
                <label for="respRate" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7-7-7M19 10v10a1 1 0 01-1 1h-3"></path></svg>
                    Respiratory Rate (breaths/min)
                </label>
                <input id="respRate" type="number" value="16" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- PTT -->
            <div class="space-y-2">
                <label for="ptt" class="flex items-center text-lg font-semibold">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pulse Transit Time (PTT in ms)
                </label>
                <input id="ptt" type="number" value="300" class="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            </div>

            <!-- Classify Button -->
            <button id="classify-btn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xl font-bold py-4 rounded-lg shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300">
                Classify
            </button>
        </div>

        <!-- Right Column: Output -->
        <div class="glass-card p-8">
            <h2 class="text-3xl font-bold text-center border-b border-white/20 pb-4">Classifier Output</h2>
            
            <div id="output-container" class="mt-6 space-y-4">
                <div id="status-card" class="p-6 rounded-2xl shadow-inner transition-all duration-300" style="background: rgba(0, 0, 0, 0.2);">
                    <h3 id="status-title" class="text-2xl font-bold">Awaiting Input...</h3>
                    <p id="status-explanation" class="text-lg mt-2">Enter sensor values and press "Classify".</p>
                </div>

                <!-- CRITICAL ALERT BOX (HIDDEN BY DEFAULT) -->
                <div id="critical-alert-box" class="hidden p-6 rounded-2xl shadow-inner transition-all duration-300 border-2" style="background: rgba(0, 0, 0, 0.2);">
                    <div class="flex items-center">
                        <svg class="w-12 h-12 text-red-400 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <div>
                            <h3 class="text-2xl font-bold">CRITICAL ALERT</h3>
                            <p id="alert-status" class="text-lg mt-1">Alerting doctor...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- NEW ---
        // Helper function to get location. It returns a "Promise".
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation is not supported by your browser."));
                } else {
                    // This will trigger the browser's permission popup
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position),
                        (error) => reject(new Error(error.message))
                    );
                }
            });
        }

        // --- UPDATED ---
        // We make the 'classify' function 'async' so we can 'await' the location.
        // I've also changed the event listener to be 'async'
        document.getElementById('classify-btn').addEventListener('click', async function() {
            // 1. Get all values
            const ppgHR = parseFloat(document.getElementById('ppgHR').value);
            const ecgHR = parseFloat(document.getElementById('ecgHR').value);
            const spo2 = parseFloat(document.getElementById('spo2').value);
            const hrv = parseFloat(document.getElementById('hrv').value);
            const respRate = parseFloat(document.getElementById('respRate').value);
            const ptt = parseFloat(document.getElementById('ptt').value);

            // 2. Get UI elements
            const statusCard = document.getElementById('status-card');
            const statusTitle = document.getElementById('status-title');
            const statusExplanation = document.getElementById('status-explanation');
            const alertBox = document.getElementById('critical-alert-box');
            const alertStatus = document.getElementById('alert-status');

            // 3. Reset UI
            statusCard.className = 'p-6 rounded-2xl shadow-inner transition-all duration-300';
            alertBox.classList.add('hidden');
            alertStatus.textContent = 'Alerting doctor...';
            alertBox.style.borderColor = 'transparent';

            // --- NEW: Get Location Before Classifying ---
            let locationString = "Location: N/A";
            try {
                // This will pop up the "Allow Location" dialog
                const position = await getLocation(); 
                // Create a clickable Google Maps link
                locationString = `Location: https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`;
                console.log("Location found:", locationString);
            } catch (error) {
                console.warn("Could not get location:", error.message);
                if (error.message.includes("User denied")) {
                    locationString = "Location: N/A (User denied permission)";
                } else {
                    locationString = `Location: N/A (${error.message})`;
                }
            }

            // 4. Classification Logic (Unchanged)
            let condition = 'Normal Sinus Rhythm';
            let explanation = 'All 6 sensor features are within their normal parameters. System is stable.';
            let cardColor = 'bg-green-500/30 border-green-400';
            let isCritical = false;

            // --- Model Logic ---
            const pulseDeficit = Math.abs(ecgHR - ppgHR);

            if (spo2 < 92 || (ppgHR > 130 && respRate > 25) || (ppgHR < 50 && ptt > 450) || (ptt < 250 && ppgHR > 120)) {
                isCritical = true;
                if (spo2 < 92) {
                    condition = 'Critical: Hypoxemia';
                    explanation = `Blood oxygen is dangerously low (${spo2}%). This is a primary critical indicator.`;
                } else if (ptt < 250 && ppgHR > 120) {
                    condition = 'Critical: Hypertensive Crisis Indicator';
                    explanation = `Extremely fast PTT (${ptt}ms) and Tachycardia (${ppgHR}bpm) indicate a potential hypertensive crisis.`;
                } else {
                    condition = 'Critical: Shock Indicator';
                    explanation = `A dangerous combination of low blood pressure (PTT: ${ptt}ms), compensatory tachycardia (HR: ${ppgHR}bpm), and rapid breathing (RR: ${respRate} br/min) indicates a shock state.`;
                }
                cardColor = 'bg-purple-600/30 border-purple-400';
            }
            else if (hrv > 120) {
                condition = 'Abnormal: Possible Atrial Fibrillation';
                explanation = `Heart Rate Variability is very high (SDNN: ${hrv}ms). This indicates a chaotic, irregular rhythm, a key sign of AFib.`;
                cardColor = 'bg-red-500/30 border-red-400';
            }
            else if (pulseDeficit > 15) {
                condition = 'Abnormal: Possible Pulse Deficit (PVCs)';
                explanation = `ECG Heart Rate (${ecgHR}bpm) and PPG Heart Rate (${ppgHR}bpm) disagree significantly. This "pulse deficit" suggests an arrhythmia like Premature Beats.`;
                cardColor = 'bg-red-500/30 border-red-400';
            }
            else if (ppgHR > 100) {
                condition = 'Abnormal: Tachycardia';
                explanation = `Heart rate is elevated (${ppgHR}bpm). This is a common arrhythmia.`;
                cardColor = 'bg-red-500/30 border-red-400';
            }
            else if (ppgHR < 60) {
                condition = 'Abnormal: Bradycardia';
                explanation = `Heart rate is too slow (${ppgHR}bpm). This can be a sign of an electrical issue.`;
                cardColor = 'bg-red-500/3D border-red-400'; // Corrected typo from 3D to 300
            }
            else if (ptt < 280) {
                condition = 'Warning: High Arterial Stiffness';
                explanation = `Pulse Transit Time is fast (${ptt}ms), suggesting arterial stiffness, a strong indicator for High Blood Pressure.`;
                cardColor = 'bg-yellow-500/30 border-yellow-400';
            }
            else if (ptt > 400) {
                condition = 'Warning: Low Arterial Pressure';
                explanation = `Pulse Transit Time is slow (${ptt}ms), suggesting low blood pressure (hypotension).`;
                cardColor = 'bg-yellow-500/30 border-yellow-400';
            }

            // 5. Update UI
            statusTitle.textContent = condition;
            statusExplanation.textContent = explanation;
            statusCard.classList.add(...cardColor.split(' '), 'border-2');

            // 6. Handle Critical Alert
            if (isCritical) {
                alertBox.classList.remove('hidden');
                alertStatus.innerHTML = 'Sending SMS alert to doctor...';
                alertBox.style.borderColor = '#f59e0b'; // Yellow for "sending"

                // --- NEW: Format the text message WITH location ---
                let messageBody = `CRITICAL ALERT: ${condition}\n\n`;
                messageBody += `DETAILS: ${explanation}\n\n`;
                messageBody += `--- PATIENT LOCATION ---\n${locationString}\n\n`; // <-- THE NEW LINE
                messageBody += `--- SENT VITALS ---\n`;
                messageBody += `PPG HR: ${ppgHR} bpm\n`;
                messageBody += `ECG HR: ${ecgHR} bpm\n`;
                messageBody += `SpO2: ${spo2}%\n`;
                messageBody += `HRV (SDNN): ${hrv} ms\n`;
                messageBody += `Resp. Rate: ${respRate} br/min\n`;
                messageBody += `PTT: ${ptt} ms`;

                // Call the function to send data to the Python server
                sendAlertToServer(messageBody);
            }
        });

        // --- UNCHANGED: sendAlertToServer function ---
        async function sendAlertToServer(message) {
            const statusEl = document.getElementById('alert-status');
            const alertBox = document.getElementById('critical-alert-box');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/send_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message }) 
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Alert sent:', result);
                    statusEl.innerHTML = `✅ Alert Sent! (SID: ${result.sid.substring(0, 10)}...)`;
                    alertBox.style.borderColor = '#22c55e'; // Green
                } else {
                    console.error('Failed to send alert:', result);
                    statusEl.innerHTML = `❌ Failed to send alert: ${result.detail}`;
                    alertBox.style.borderColor = '#ef4444'; // Red
                }
            } catch (error) {
                console.error('Fetch error:', error);
                statusEl.innerHTML = '❌ ERROR: Could not connect to the local server (FastAPI). Is it running on port 8000?';
                alertBox.style.borderColor = '#ef4444'; // Red
            }
        }
    </script>
</body>
</html>

